<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Inversor League - Ranking</title>
  <style>
    /* === TEMA OSCURO: Textos principales en BLANCO === */
    body {
      font-family: 'Arial', sans-serif;
      margin: 40px;
      background: #121212; /* Fondo negro profundo */
      color: #e0e0e0; /* Gris claro para texto general (mejor lectura) */
    }
    h1, h2 {
      text-align: center;
      color: white; /* Blanco puro para t√≠tulos */
      text-shadow: 0 1px 3px rgba(255,255,255,0.1);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.5);
      background: #1e1e1e; /* Fondo oscuro para tablas */
    }
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #444;
    }
    th {
      background-color: #003366;
      color: white;
      font-weight: bold;
    }
    .profit {
      color: #4caf50; /* Verde claro */
      font-weight: bold;
    }
    .loss {
      color: #f44336; /* Rojo claro */
      font-weight: bold;
    }
    .highlight {
      background-color: #fffacd !important; /* Amarillo suave */
      color: black; /* Texto negro sobre amarillo */
    }
    .total {
      font-weight: bold;
      font-size: 1.2em;
      margin: 20px 0;
      text-align: right;
    }
    .user-card {
      background: #2d2d2d;
      padding: 15px;
      margin: 10px 0;
      border-radius: 8px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.3);
      cursor: pointer;
      color: white;
    }
    .user-card:hover {
      background: #3c3c3c;
    }
    .back-link {
      display: block;
      margin: 20px 0;
      color: white; /* Enlace de vuelta en blanco */
      text-decoration: none;
      font-weight: bold;
    }
    .back-link:hover {
      text-decoration: underline;
      color: #ddd;
    }
    .section {
      margin: 30px 0;
    }
    .section-title {
      color: white;
      margin-bottom: 10px;
    }
    .crypto {
      background: #1a237e;
      padding: 10px;
      border-left: 4px solid #003366;
    }
    .stock {
      background: #332300;
      padding: 10px;
      border-left: 4px solid #ffa000;
    }
    .update-time {
      text-align: center;
      font-style: italic;
      color: #aaa;
      margin: 10px 0;
    }
    .refresh-btn {
      display: block;
      margin: 20px auto;
      padding: 10px 20px;
      background-color: #003366;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
    }
    .refresh-btn:hover {
      background-color: #002244;
    }
    .refresh-btn:disabled {
      background-color: #555;
      cursor: not-allowed;
    }
    .status {
      text-align: center;
      padding: 10px;
      font-weight: bold;
    }
    .status.loading { color: orange; }
    .status.error { color: #f44336; }
    .status.success { color: #4caf50; }
  </style>
</head>
<body>
  <div id="main-view">
    <h1>üèÜ Investment League 2025</h1>
    <p style="text-align:center;"><strong>Actualizaci√≥n autom√°tica cada 60 segundos</strong></p>
    <button class="refresh-btn" onclick="fetchData(true)">Actualizar Yahoo</button>
    <div class="status" id="status">Cargando datos...</div>
    <div class="update-time" id="update-time">√öltima actualizaci√≥n: Cargando...</div>

    <!-- Tasa EUR/USD -->
    <div style="text-align:center; margin: 20px 0;">
      <span id="eurusd">Tasa EUR/USD: cargando...</span>
    </div>

    <!-- Ranking -->
    <h2>üìä Ranking</h2>
    <table id="ranking-table">
      <thead>
        <tr>
          <th>#</th>
          <th>Usuario</th>
          <th>Valor Actual (‚Ç¨)</th>
          <th>PyG (‚Ç¨)</th>
          <th>Rentabilidad (%)</th>
        </tr>
      </thead>
      <tbody id="ranking-body">
        <tr><td colspan="5">Cargando...</td></tr>
      </tbody>
    </table>

    <!-- Detalle por usuario -->
    <h2>üîç Carteras Individuales</h2>
    <div id="portfolios"></div>
  </div>

  <!-- Vista individual -->
  <div id="individual-view" style="display:none;">
    <a href="#" class="back-link" onclick="showMainView(); return false;">‚Üê Volver al ranking</a>
    <button class="refresh-btn" onclick="fetchData(true)">Actualizar Yahoo</button>
    <div class="status" id="status-individual">Cargando datos...</div>
    <h2 id="user-title">Cartera de [Nombre]</h2>
    <div id="user-details"></div>
    <div class="update-time" id="update-time-individual">√öltima actualizaci√≥n: Cargando...</div>

    <h3>Detalles de Activos</h3>
    <table id="user-investments-table">
      <thead>
        <tr>
          <th>Activo</th>
          <th>Tipo</th>
          <th>Cantidad</th>
          <th>Precio Compra (‚Ç¨)</th>
          <th>Precio Actual (‚Ç¨)</th>
          <th>Var. 24h</th>
          <th>Valor Actual (‚Ç¨)</th>
          <th>PyG (‚Ç¨)</th>
          <th>Rentabilidad (%)</th>
        </tr>
      </thead>
      <tbody id="user-investments-body">
        <tr><td colspan="9">Cargando...</td></tr>
      </tbody>
    </table>
  </div>

  <script>
    const DATA_FILE = 'data.json';
    const MAX_RETRIES = 3;
    const RETRY_DELAY = 2000;

    let eurusd = 1.08;
    let currentView = 'main';
    let allData = null;
    let yahooPrices = {};
    let yahooChanges24h = {};
    let userResults = [];

    function getCurrentTime() {
      const now = new Date();
      return now.toLocaleString('es-ES', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
    }

    async function fetchWithRetry(url, options = {}) {
      let lastError;
      for (let i = 0; i < MAX_RETRIES; i++) {
        try {
          console.log(`Intentando: ${url}`);
          const response = await fetch(url, options);
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          return await response.json();
        } catch (error) {
          lastError = error;
          if (i < MAX_RETRIES - 1) {
            console.warn(`Intento ${i+1} fallido para ${url}. Reintentando en ${RETRY_DELAY}ms...`);
            await new Promise(resolve => setTimeout(resolve, RETRY_DELAY));
          }
        }
      }
      throw lastError;
    }

    async function fetchData(force = false) {
      const btns = document.querySelectorAll('.refresh-btn');
      btns.forEach(btn => {
        btn.disabled = true;
        btn.textContent = 'Actualizando...';
      });

      document.getElementById('status').textContent = 'Actualizando precios...';
      document.getElementById('status').className = 'status loading';
      if (currentView === 'individual') {
        document.getElementById('status-individual').textContent = 'Actualizando precios...';
        document.getElementById('status-individual').className = 'status loading';
      }

      try {
        if (!allData || force) {
          const res = await fetch(DATA_FILE + '?t=' + new Date().getTime());
          allData = await res.json();
        }

        const symbols = [...new Set(allData.users.flatMap(u => u.investments.map(i => i.symbol)))];

        yahooPrices = {};
        yahooChanges24h = {};
        const failedSymbols = [];

        for (const sym of symbols) {
          let success = false;
          for (let attempt = 0; attempt < MAX_RETRIES && !success; attempt++) {
            try {
              const yahooUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${sym}?range=1d&interval=1d`;
              const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(yahooUrl)}`;
              
              const d = await fetchWithRetry(proxyUrl, { signal: AbortSignal.timeout(15000) });

              if (d && d.chart && d.chart.result && d.chart.result[0]) {
                const result = d.chart.result[0];
                const meta = result.meta;
                const currentPrice = meta.regularMarketPrice;
                const prevClose = meta.chartPreviousClose;

                yahooPrices[sym] = currentPrice || 0;

                if (prevClose && currentPrice) {
                  const change24h = ((currentPrice - prevClose) / prevClose) * 100;
                  yahooChanges24h[sym] = change24h;
                } else {
                  yahooChanges24h[sym] = 0;
                }
                success = true;
              } else {
                console.warn(`‚ö†Ô∏è ${sym}: No se encontr√≥ precio en los datos`);
                yahooPrices[sym] = 0;
                yahooChanges24h[sym] = 0;
              }
            } catch (e) {
              console.warn(`‚ùå Error al obtener ${sym} (intento ${attempt + 1}):`, e.message);
              if (attempt === MAX_RETRIES - 1) {
                failedSymbols.push(sym);
                yahooPrices[sym] = 0;
                yahooChanges24h[sym] = 0;
              }
            }
          }
        }

        if (failedSymbols.length > 0) {
          console.warn("S√≠mbolos fallidos:", failedSymbols);
        }

        // Actualizar tasa EUR/USD
        try {
          const eurusdData = await fetchWithRetry('https://api.exchangerate-api.com/v4/latest/USD');
          eurusd = 1 / eurusdData.rates.EUR;
          document.getElementById('eurusd').textContent = `Tasa EUR/USD: ${eurusd.toFixed(4)}`;
        } catch (e) {
          console.warn("No se pudo actualizar EUR/USD");
        }

        userResults = allData.users.map(user => {
          let investedEur = 0;
          let currentEur = 0;

          user.investments.forEach(inv => {
            const buyPriceEur = inv.currency === 'EUR' ? inv.buy_price_eur : inv.buy_price_usd / eurusd;
            const quantity = inv.quantity;
            const currentPriceUsd = yahooPrices[inv.symbol];
            const currentPriceEur = inv.currency === 'EUR' ? currentPriceUsd : (currentPriceUsd || 0) / eurusd;

            investedEur += quantity * buyPriceEur;
            currentEur += quantity * currentPriceEur;
          });

          return {
            name: user.name,
            invested: investedEur,
            current: currentEur,
            profit: currentEur - investedEur,
            pct: investedEur > 0 ? ((currentEur - investedEur) / investedEur) * 100 : 0
          };
        });

        userResults.sort((a, b) => b.profit - a.profit);

        const tbody = document.getElementById('ranking-body');
        tbody.innerHTML = '';
        userResults.forEach((r, idx) => {
          const row = tbody.insertRow();
          row.classList.toggle('highlight', r.name === 'T√∫');
          row.innerHTML = `
            <td>${idx+1}</td>
            <td><a href="#" onclick="showUserView('${r.name}'); return false;" style="color: white; text-decoration: none; font-weight: bold;">${r.name}</a></td>
            <td>‚Ç¨${formatMoney(r.current)}</td>
            <td class="${r.profit >= 0 ? 'profit' : 'loss'}">‚Ç¨${formatMoney(r.profit)}</td>
            <td class="${r.pct >= 0 ? 'profit' : 'loss'}">${r.pct >= 0 ? '+' : ''}${r.pct.toFixed(2)}%</td>
          `;
        });

        const portfoliosDiv = document.getElementById('portfolios');
        portfoliosDiv.innerHTML = '';
        userResults.forEach(r => {
          const card = document.createElement('div');
          card.className = 'user-card';
          card.innerHTML = `<strong>${r.name}</strong>: ‚Ç¨${formatMoney(r.current)} (${r.pct >= 0 ? '+' : ''}${r.pct.toFixed(2)}%)`;
          card.onclick = () => showUserView(r.name);
          portfoliosDiv.appendChild(card);
        });

        document.getElementById('update-time').textContent = `√öltima actualizaci√≥n: ${getCurrentTime()}`;
        document.getElementById('status').textContent = `‚úÖ Actualizado (${symbols.length} activos)`;
        document.getElementById('status').className = 'status success';

        if (currentView === 'individual' && window.currentUserName) {
          showUserView(window.currentUserName);
        }
      } catch (e) {
        console.error("Error en fetchData:", e);
        document.getElementById('status').textContent = `‚ùå Error: ${e.message}`;
        document.getElementById('status').className = 'status error';
        document.getElementById('ranking-body').innerHTML = '<tr><td colspan="5">Error al cargar datos. Revisa tu conexi√≥n o el archivo data.json.</td></tr>';
      } finally {
        btns.forEach(btn => {
          btn.disabled = false;
          btn.textContent = '‚ü≥  Actualizar';
        });
      }
    }

    function showUserView(userName) {
      currentView = 'individual';
      window.currentUserName = userName;

      const userResult = userResults.find(u => u.name === userName);
      if (!userResult) return;

      document.getElementById('main-view').style.display = 'none';
      document.getElementById('individual-view').style.display = 'block';

      document.getElementById('user-title').textContent = `Cartera de ${userName}`;
      document.getElementById('user-details').innerHTML = `
        <p><strong>Valor Actual:</strong> ‚Ç¨${formatMoney(userResult.current)}</p>
        <p><strong>Rentabilidad Total:</strong> ‚Ç¨${formatMoney(userResult.profit)} (${userResult.pct >= 0 ? '+' : ''}${userResult.pct.toFixed(2)}%)</p>
      `;

      document.getElementById('update-time-individual').textContent = `√öltima actualizaci√≥n: ${getCurrentTime()}`;
      const user = allData.users.find(u => u.name === userName);
      if (!user) return;

      const tbody = document.getElementById('user-investments-body');
      tbody.innerHTML = '';

      user.investments.forEach(inv => {
        const buyPriceEur = inv.currency === 'EUR' ? inv.buy_price_eur : inv.buy_price_usd / eurusd;
        const quantity = inv.quantity;
        const currentPriceUsd = yahooPrices[inv.symbol];
        const change24h = yahooChanges24h[inv.symbol] || 0;

        if (!currentPriceUsd || currentPriceUsd <= 0) {
          console.log(`‚ö†Ô∏è Precio no disponible para ${inv.symbol}`);
        }

        const currentPriceEur = inv.currency === 'EUR' ? currentPriceUsd : currentPriceUsd / eurusd;
        const currentValue = quantity * currentPriceEur;
        const profit = currentValue - (quantity * buyPriceEur);
        const pct = (buyPriceEur > 0) ? (profit / (quantity * buyPriceEur)) * 100 : 0;

        // --- L√çNEA MODIFICADA: A√±adir enlace a Yahoo Finance ---
        const symbolLink = `<a href="https://finance.yahoo.com/quote/${inv.symbol}" target="_blank" style="color: white; text-decoration: underline;">${inv.symbol}</a>`;

        const row = tbody.insertRow();
        row.innerHTML = `
          <td>${symbolLink}</td>
          <td>${inv.type}</td>
          <td>${quantity}</td>
          <td>‚Ç¨${formatMoney(buyPriceEur)}</td>
          <td>‚Ç¨${formatMoney(currentPriceEur)}</td>
          <td class="${change24h >= 0 ? 'profit' : 'loss'}">${change24h >= 0 ? '+' : ''}${change24h.toFixed(2)}%</td>
          <td>‚Ç¨${formatMoney(currentValue)}</td>
          <td class="${profit >= 0 ? 'profit' : 'loss'}">‚Ç¨${formatMoney(profit)}</td>
          <td class="${pct >= 0 ? 'profit' : 'loss'}">${pct >= 0 ? '+' : ''}${pct.toFixed(2)}%</td>
        `;
      });

      document.getElementById('status-individual').textContent = `‚úÖ Cartera actualizada (${user.investments.length} activos)`;
      document.getElementById('status-individual').className = 'status success';
    }

    function showMainView() {
      currentView = 'main';
      document.getElementById('main-view').style.display = 'block';
      document.getElementById('individual-view').style.display = 'none';
    }

    function formatMoney(n) {
      return new Intl.NumberFormat('de-DE', { minimumFractionDigits: 2 }).format(n);
    }

    // Primera carga
    fetchData();
    setInterval(() => fetchData(false), 60000);
  </script>
</body>
</html>